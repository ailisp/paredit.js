!function(){var e="undefined"!=typeof module&&module.require,n=e?module.exports:window.paredit={};e&&(n.reader=module.require("./lib/reader").reader,n.navigator=module.require("./lib/navigator").navigator,n.editor=module.require("./lib/editor").editor,n.ace=module.require("./lib/ace").ace),n.parse=function(e,t){t=t||{};var r=!!t.addSourceForLeafs,i=[],o=n.reader.readSeq(e,function(n,t,o,u,a){var c={type:n,start:o.idx,end:u.idx};return"error"===n?(c.error=t.error,i.push(c)):r&&"list"!==n&&(c.source=e.slice(c.start,c.end)),"list"===n&&(c.children=t),("list"===n||"string"===n)&&(c.open=a.open,c.close=a.close),c});return{type:"toplevel",start:0,end:o&&o.length&&o[o.length-1].end||0,errors:i,children:o}}}(),function(e){var n="undefined"!=typeof module&&module.require,t=n?module.exports:window.paredit;e(t)}(function(e){var n=e.util={merge:function(e){return arguments.length>1?n.merge(Array.prototype.slice.call(arguments)):Array.isArray(e[0])?Array.prototype.concat.apply([],e):e.reduce(function(e,n){for(var t in n)n.hasOwnProperty(t)&&(e[t]=n[t]);return e},{})},mapTree:function(e,t,r){var i=(r(e)||[]).map(function(e){return n.mapTree(e,t,r)});return t(e,i)},flatFilterTree:function(e,t,r){var i=[];return t(e)&&i.push(e),i.concat((r(e)||[]).reduce(function(e,i){return e.concat(n.flatFilterTree(i,t,r))},[]))},last:function(e){return e[e.length-1]},times:function(e,n){return new Array(e+1).join(n)}}}),function(e){var n="undefined"!=typeof module&&module.require,t=n?module.exports:window.paredit;e(t)}(function(e){function n(e,n,f,p,h){var v=n[0];if(!v&&e&&y[e])return{input:n,context:f,pos:p,flag:w};if(!v&&!y[e])return{input:n,context:f,pos:p,flag:w};if(/\s|,/.test(v))return{input:n.slice(1),context:f,pos:x(p,v)};if(A.test(v))return c(n,f,p,h);if(";"===v)return a(n,f,p,h);if('"'===v)return r(n,f,p,h);if("\\"===v)return i(n,f,p,h);if(/[0-9]/.test(v))return u(n,f,p,h);if(k.test(v))return o(n,f,p,h);if(b.indexOf(v)>-1){if(!e){var T=l(n,f,p,h);return{input:T.input,context:T.context,pos:T.pos}}return{input:n,context:f,pos:p,flag:m}}if(S.indexOf(v)>-1){var q,C,I=g(p),O=t(v,n.slice(1),Object.freeze([]),x(p,v),h),F=O.input[0];if(F!==y[v]){var j=g(O.pos),R="Expected '"+y[v]+"'"+(F?" but got '"+F+"'":" but reached end of input"),U=s(R,I,j);q=d(h,"error",U,I,j),C=F?x(O.pos,F):O.pos}else C=F?x(O.pos,F):O.pos,q=d(h,"list",O.context,I,C,{open:v,close:y[v]});f=f.concat([q]);var $=O.input.slice(F?1:0);return{input:$,context:f,pos:C}}var I=g(p),j=x(p,v),U=s("Unexpected character: "+v,I,j);return U=d(h,"error",U,I,j),f=f.concat([U]),{input:n.slice(1),context:f,pos:j}}function t(e,t,r,i,o){for(var u,a=0;;){if(a++,a>1e4)throw new Error("endless loop at "+h(i));if(u=n(e,t,r,i,o),t=u.input,r=u.context,i=u.pos,u.flag===w||u.flag===m&&(e||!t.length))break}return{input:t,context:r,pos:i}}function r(e,n,t,r){var i=!1,o=g(t),u=e[0];return t=x(t,e[0]),e=e.slice(1),f(e,t,function(e){return i||'"'!==e?(i?i=!1:"\\"===e&&(i=!0),!0):!1},function(e,t,i,a){u=u+e+t[0],a=x(a,t[0]),t=t.slice(1);var c=d(r,"string",u,o,a,{open:'"',close:'"'});return n=n.concat([c]),{pos:a,input:t,context:n}})}function i(e,n,t,r){var i=g(t),o=e.slice(0,2),u=x(t,o),a=d(r,"char",o,i,u),c=e.slice(2);return n=n.concat([a]),{pos:u,input:c,context:n}}function o(e,n,t,r){return f(e,t,function(e){return k.test(e)},function(e,t,i,o){var u=d(r,"symbol",e,i,o);return n=n.concat([u]),{pos:o,input:t,context:n}})}function u(e,n,t,r){return f(e,t,function(e){return/[0-9]/.test(e)},function(e,t,i,o){var u=d(r,"number",Number(e),i,o);return n=n.concat([u]),{pos:o,input:t,context:n}})}function a(e,n,t,r){for(var i=g(t),o="",u=e;u.length&&/^\s*;/.test(u);){var a=v(u);o+=a[0],u=a[1]}var c=x(t,o),l=d(r,"comment",o,i,c);return n=n.concat([l]),{pos:c,input:u,context:n}}function c(e,n,t,r){return f(e,t,function(e){return A.test(e)},function(e,t,i,o){var u=d(r,"special",e,i,o);return n=n.concat([u]),{pos:o,input:t,context:n}})}function l(e,n,t,r){return f(e,t,function(e){return b.indexOf(e)>-1},function(e,t,i,o){var u=s("Unexpected input: '"+e+"'",i,o),a=d(r,"error",u,i,o);return n=n.concat([a]),{pos:o,input:t,context:n}})}function s(e,n,t){return{error:e+" at line "+(t.row+1)+" column "+t.column,start:g(n),end:g(t)}}function d(e,n,t,r,i,o){return e?e(n,t,g(r),g(i),o):t}function f(e,n,t,r){for(var i=g(n),o="",u=0;u<e.length&&t(e[u]);u++)o+=e[u];return r(o,e.slice(o.length),i,x(n,o))}function p(){return{idx:0,column:0,row:0}}function g(e){return{idx:e.idx,column:e.column,row:e.row}}function h(e){return JSON.stringify(e)}function v(e){var n=e.indexOf("\n");n=n>-1?n+1:e.length;var t=e.slice(0,n),r=e.slice(n);return[t,r]}function x(e,n){e.idx+=n.length;var t=n.split("\n"),r=t.length;e.row+=r-1;var i=t[r-1].length;return e.column=r>1?i:e.column+i,e}e.reader={readSeq:function(e,n){return t(null,e,Object.freeze([]),p(),n).context},readSexp:function(e,t){return n(null,e,Object.freeze([]),p(),t).context[0]}};var m={},w={},y={"[":"]","(":")","{":"}"},S=Object.keys(y),b=S.map(function(e){return y[e]}),k=/[^\s\[\]\(\)\{\},]/,A=/[`@^#~]/}),function(e){var n="undefined"!=typeof module&&module.require,t=n?module.exports:window.paredit,r=n?module.require("./util").util:window.paredit.util;e(r,t)}(function(e,n){function t(e){return e[e.length-1]}function r(e){return e.children||[]}var i=n.navigator={forwardSexp:function(e,n){var t=o.nextSexp(e,n);return t?t.end:n},backwardSexp:function(e,n){var t=o.prevSexp(e,n);return t?t.start:n},forwardDownSexp:function(e,n){var t=o.nextSexp(e,n,function(e){return"list"===e.type});return t?t.children&&t.children[0]?t.children[0].start:t.start+1:n},backwardUpSexp:function(e,n){var r=o.sexpsAt(e,n,function(e){return"list"===e.type&&e.start!==n&&e.end!==n});return r&&r.length?t(r).start:n},sexpRange:function(e,n){return i.sexpRangeExpansion(e,n,n)},sexpRangeExpansion:function(n,i,o){var u=t(e.flatFilterTree(n,function(e){return"toplevel"===e.type?!1:i===o?e.start<=i&&o<=e.end:e.start===i?o<e.end:e.end===o?e.start<i:e.start<i&&o<e.end},r));if(!u)return null;var a=u.start===i||u.end===o;if("list"===u.type||"string"===u.type){if(a&&(i===u.start||o===u.end))return[u.start,u.end];if(u.start+1<i||o<u.end-1)return[u.start+1,u.end-1]}return[u.start,u.end]},rangeForDefun:function(e,n){var t=e.children&&e.children.filter(function(e){return e.start<=n&&n<=e.end})[0];return t?[t.start,t.end]:null}},o=n.walk={hasChildren:function(e){return"list"===e.type||"toplevel"===e.type},containingSexpsAt:function(n,t,i){return e.flatFilterTree(n,function(e){return("toplevel"===e.type||e.start<t&&t<e.end)&&(!i||i(e))},r)},sexpsAt:function(n,t,i){return e.flatFilterTree(n,function(e){return e.start<=t&&t<=e.end&&(!i||i(e))},r)},nextSexp:function(n,i,u){var a=e.flatFilterTree(n,function(e){return e.start<=i&&i<e.end&&o.hasChildren(e)},r);if(!a.length)return null;var c=a.filter(function(e){return e.start===i&&"toplevel"!==e.type})[0];if(c)return c;var l=t(a).children.filter(function(e){return i<=e.start&&(!u||!!u(e))});return l.length?l[0]:null},prevSexp:function(n,i,u){var a=e.flatFilterTree(n,function(e){return e.start<i&&i<=e.end&&o.hasChildren(e)},r);if(!a.length)return null;var c=a.filter(function(e){return e.end===i&&"toplevel"!==e.type})[0];if(c)return c;var l=t(a).children.filter(function(e){return e.end<=i&&(!u||!!u(e))});return l.length?t(l):null},stringify:function(n){return e.mapTree(n,function(t,r){return"list"===t.type||"toplevel"===t.type?"("+r.join(" ")+")":t.source?t.source:e.times(n.end-n.start,"x")},function(e){return e&&e.children||[]})}}}),function(e){var n="undefined"!=typeof module&&module.require,t=n?module.exports:window.paredit,r=n?module.require("./util").util:window.paredit.util,i=n?module.require("./navigator").navigator:window.paredit.navigator,o=n?module.require("./navigator").walk:window.paredit.walk;e(i,o,r,t)}(function(e,n,t,r){function i(e,n){return e.slice(0,n).lastIndexOf("\n")+1}function o(e,n){return n-i(e,n)}function u(e,n,t){if("toplevel"===n.type)return 0;var r=s(n,t);return f(n,e)?o(e,n.start+n.open.length+1):r.length<=1||"("!==n.open?o(e,n.start+n.open.length):o(e,r[1].start)}function a(e){return e[e.length-1]}function c(e,n){return new Array(e+1).join(n)}function l(e,n){return t.mapTree(n,function(n,r){return t.merge(n,{start:n.start+e,end:n.end+e,children:r})},function(e){return e.children})}function s(e,n){return e.children.filter(function(e){return e.end<=n})}function d(e,n){return e.children.filter(function(e){return n<=e.start})}function f(e){if(!n.hasChildren(e)||!e.children.length)return!1;var t=e.children[0].source;return t?r.specialForms.some(function(n){return"string"==typeof n?n===t:"function"==typeof n?n(t,e.children[0]):n instanceof RegExp?n.test(t):!1}):!1}r.specialForms=["ns","try","var","do","fn","let","loop","monitor-enter","monitor-exit","recur","case",/^def/,/^if/,/^when/,/->/,/^with/,"testing"];var p=r.editor={rewrite:function(e,r,i){var o=i.length?a(i).end-r.end:r.start-r.end,u=n.containingSexpsAt(e,r.start),c=u.reduceRight(function(e,n){var r,i=n.children.indexOf(e.original);r=i>-1?n.children.slice(0,i).concat(e.nodes).concat(n.children.slice(i+1).map(l.bind(null,o))):n.children;var u=t.merge(n,{end:n.end+o,children:r});return{original:n,nodes:[u]}},{original:r,nodes:i});return c.nodes[0]},spliceSexp:function(e,t,r){var i=n.containingSexpsAt(e,r,n.hasChildren);if(!i.length)return null;var o=i.pop(),u=r-o.open.length,a=[["remove",o.end-1,o.close.length],["remove",o.start,o.open.length]];return{changes:a,newIndex:u}},splitSexp:function(e,t,r){var i=n.containingSexpsAt(e,r);if(!i.length)return null;var o=i.pop();if(!n.hasChildren(o)&&"string"!==o.type)return null;var u=o.close+" "+o.open,a=r+o.close.length,c=[["insert",r,u]];return{changes:c,newIndex:a}},killSexp:function(e,t,r,i){i=i||{};var o=i.count||1,u=i.backward,c=n.containingSexpsAt(e,r,n.hasChildren);if(!c.length)return null;var l=c.pop();if(u){var f=s(l,r);if(!f.length)return null;var p=f.slice(-o)[0].start,g=[["remove",p,r-p]],h=p}else{var v=d(l,r);if(!v.length)return null;var h=r,g=[["remove",r,a(v.slice(0,o)).end-r]]}return{changes:g,newIndex:h}},wrapAround:function(e,t,r,i,o,u){var c=u&&u.count||1,l=n.containingSexpsAt(e,r,n.hasChildren);if(!l.length)return null;var s=a(l),d=s.children.filter(function(e){return e.start>=r}).slice(0,c),f=a(d),p=[["insert",r,i],["insert",(f?f.end:r)+i.length,o]];return{changes:p,newIndex:r+i.length}},closeAndNewline:function(e,t,r,i){i=i||")";var u=n.containingSexpsAt(e,r,function(e){return n.hasChildren(e)&&e.close===i});if(!u.length)return null;var l=a(u),s=c(o(t,l.start)," "),d="\n"+s,f=[["insert",l.end,d]];return{changes:f,newIndex:l.end+d.length}},barfSexp:function(e,t,r,i){var o=i&&i.backward,u=n.containingSexpsAt(e,r,n.hasChildren);if(!u.length)return null;var c=a(u);if(o){var l=s(c,r);if(!l.length)return null;var f=[["insert",l[1]?l[1].start:r,c.open],["remove",c.start,c.open.length]]}else{var p=d(c,r);if(!p.length)return;var f=[["remove",c.end-c.close.length,c.close.length],["insert",p[p.length-2]?p[p.length-2].end:r,c.close]]}return{changes:f,newIndex:r}},slurpSexp:function(e,t,r,i){var o=i&&i.backward,u=i.count||1,c=n.containingSexpsAt(e,r,n.hasChildren);if(c.length<2)return null;var l=c.pop(),f=c.pop();if(o){var p=s(f,r);if(!p.length)return;var g=[["remove",l.start,l.open.length],["insert",p.slice(-u)[0].start,l.open]]}else{var h=d(f,r);if(!h.length)return;var g=[["insert",a(h.slice(0,u)).end,l.close],["remove",l.end-l.close.length,l.close.length]]}return{changes:g,newIndex:r}},indentRange:function(e,r,o,s){var f=i(r,o),g=r.slice(s).indexOf("\n");g=g>-1?g+s:r.length;var h=r.slice(f,g).split("\n");return h.reduce(function(e,r){var i=e.idx,o=e.changes,s=e.ast,f=e.src,g=n.containingSexpsAt(s,i,n.hasChildren),h=a(g);if(!h)return{idx:i+r.length+1,newIndex:i,changes:o,ast:s,src:f};var v=r.match(/^\s*/)[0],x=u(f,h,i)-v.length,m=r.length+x;if(x>0){var w=c(x," ");o.push(["insert",i,w]),f=f.slice(0,i)+w+f.slice(i)}else 0>x&&(o.push(["remove",i,-x]),f=f.slice(0,i)+f.slice(i-x));var y=d(h,i)[0];if(y){var S=l(x,y);s=p.rewrite(s,y,[S])}else s=p.rewrite(s,h,[t.merge(h,{end:h.end+x})]);return{idx:i+m+1,newIndex:i+x,changes:o,ast:s,src:f}},{idx:f,changes:[],ast:e,src:r})}}}),function(e){var n="undefined"!=typeof module&&module.require,t=n?module.exports:window.paredit;e(t)}(function(e){e.ace={undoStackSize:function(e){return e.session.getUndoManager().$undoStack.length},mergeLast2Undos:function(e){var n=e.session.getUndoManager();if(n.$undoStack.length>=2){n.dirtyCounter--;var t=n.$undoStack.pop(),r=n.$undoStack[n.$undoStack.length-1],i=t.reduce(function(e,n){return e.concat(n.deltas)},[]);r.last().deltas=r.last().deltas.concat(i)}},indent:function(n,t,r){var i=n.session.$ast;if(i){"number"!=typeof t&&(t=n.session.doc.positionToIndex(n.getSelectionRange().start)),"number"!=typeof r&&(r=n.session.doc.positionToIndex(n.getSelectionRange().end));var o=e.editor.indentRange(i,n.getValue(),t,r);e.ace.applyChanges(n,o.changes,o.changes.newIndex,!1)}},applyChanges:function(n,t,r,i){if(t&&t.length){var o=e.ace.undoStackSize(n);if(t.forEach(function(e){var t=e[0];"insert"===t?n.session.insert(n.session.doc.indexToPosition(e[1]),e[2]):"remove"===t&&n.session.remove({start:n.session.doc.indexToPosition(e[1]),end:n.session.doc.indexToPosition(e[1]+e[2])})}),r&&n.moveCursorToPosition(n.session.doc.indexToPosition(r)),i){n.session.$ast=paredit.parse(n.getValue(),{addSourceForLeafs:!0});var u="object"==typeof i?i.start:t[0][1],a="object"==typeof i?i.end:t[t.length-1][1];e.ace.indent(n,u,a),e.ace.undoStackSize(n)-o>=2&&e.ace.mergeLast2Undos(n)}else n.session.markUndoGroup()}}}});