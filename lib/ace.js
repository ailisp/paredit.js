/*global window, process, global*/

;(function(run) {
  var isNodejs = typeof module !== "undefined" && module.require;
  var exports = isNodejs ? module.exports : window.paredit;
  run(exports);
})(function(exports) {

  exports.ace = {

    applyChanges: function(ed, changes, newIndex) {
      // ed: ace editor instance
      // changes:  alist of insert/remove instructions generated by
      //           paredit.editor
      // newIndex: where to put the cursor after applying the changes
      if (!changes || !changes.length) return;
      ed.session.markUndoGroup();
      changes.forEach(function(ea) {
        var type = ea[0];
        if (type === 'insert') {
          ed.session.insert(
            ed.session.doc.indexToPosition(ea[1]), ea[2]);
        } else if (type === 'remove') {
          ed.session.remove({
            start: ed.session.doc.indexToPosition(ea[1]),
            end: ed.session.doc.indexToPosition(ea[1]+ea[2])
          });
        }
      });
      ed.session.markUndoGroup();

      if (newIndex)
        ed.moveCursorToPosition(
          ed.session.doc.indexToPosition(newIndex));
    }

  }
});
